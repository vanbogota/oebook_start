# Recovery Code Authentication System

## Overview
This document describes the passwordless authentication system using recovery codes implemented in the Open European Book application.

## Key Features

### 1. **Passwordless Registration**
- Users create an account by providing only a nickname and selecting a library
- No password required
- Upon registration, a unique 16-character recovery code is generated

### 2. **Recovery Code Format**
- Format: `XXXX-XXXX-XXXX-XXXX`
- 16 alphanumeric characters (excluding similar-looking characters like I, O, 0, 1)
- Cryptographically secure random generation using `crypto.getRandomValues()`
- Used as authentication credential for account recovery

### 3. **Data Storage**

#### Firebase Firestore
- User profiles stored in `users` collection
- Document ID = Auto-generated UUID (standard Firebase UID)
- Recovery code stored as separate field with index for quick lookup
- Stored fields:
  - `nickname`: User's chosen display name
  - `library`: Selected library ID
  - `recoveryCode`: The unique recovery code (indexed field)
  - `isProfileComplete`: Boolean flag
  - `createdAt`: Account creation timestamp
  - `updatedAt`: Last update timestamp

#### Local Storage
- Key: `oebook_uid` - Firebase document UID for fast authentication
- Key: `oebook_profile` - Complete user profile object (cached)
- Enables automatic login on same device
- Cleared on logout

### 4. **Authentication Flow**

#### New User Registration
1. User fills signup form (nickname + library + terms acceptance)
2. System generates unique recovery code
3. New document created in Firebase with auto-generated UID
4. Recovery code saved as indexed field in the document
5. UID and profile saved to localStorage
6. Recovery code displayed to user with copy functionality
7. User must save the code (warned it won't be shown again)
8. User clicks "Continue to App" to proceed

#### Returning User (Same Device)
1. Application checks localStorage for saved UID
2. If UID exists, fetches user profile from Firebase by document ID
3. If Firebase data available, local cache updated
4. If Firebase unavailable, uses cached profile data
5. User automatically logged in

#### Account Recovery (New Device)
1. User navigates to `/restore` page
2. Enters recovery code (auto-formatted as they type)
3. System validates format
4. Queries Firebase for document with matching recoveryCode field
5. If found, saves UID and profile to localStorage
6. User logged in and redirected to main page

### 5. **Security Considerations**

#### Code Generation
```typescript
// Uses cryptographically secure random number generator
const randomArray = new Uint32Array(1);
crypto.getRandomValues(randomArray);
```

#### Document ID Generation
```typescript
// Firebase auto-generates UUID for document ID
const newUserRef = doc(db, 'users', crypto.randomUUID());
const uid = newUserRef.id;
```

#### Code Validation
- Format validation: `/^[A-Z2-9]{4}-[A-Z2-9]{4}-[A-Z2-9]{4}-[A-Z2-9]{4}$/`
- Auto-formatting during input
- Excludes confusing characters (I, O, 0, 1)

#### Uniqueness
- Document UID: Auto-generated by Firebase (guaranteed unique)
- Recovery code: Indexed field with query capability
- Query by recovery code: `where('recoveryCode', '==', code)`

### 6. **User Experience**

#### Registration Success Screen
- Green success banner
- Recovery code displayed in large, copyable input
- Copy button with visual feedback
- Warning messages about code importance
- "Continue to App" button

#### Recovery Page
- Clean interface with key icon
- Auto-formatting input field
- Clear error messages
- Loading state during verification
- Success toast notification

#### Navigation
- Link to recovery from signup page (before and after registration)
- Clear separation between new user and returning user flows

### 7. **Technical Implementation**

#### Key Files
- `/src/utils/recoveryCode.ts` - Code generation and validation utilities
- `/src/contexts/LocalAuthContext.tsx` - Authentication context with recovery code logic
- `/src/components/SignupForm.tsx` - Registration form with recovery code display
- `/src/components/RecoveryForm.tsx` - Account recovery interface
- `/src/types/interfaces.ts` - Updated UserProfile type

#### Context API Updates
```typescript
type AuthContextType = {
  userProfile: UserProfile | null;
  loading: boolean;
  signOut: () => Promise<void>;
  updateUserProfile: (data: Partial<UserProfile>) => Promise<void>;
  createUserProfile: (nickname: string, library: string) => Promise<string>;
};
```

#### UserProfile Interface
```typescript
export interface UserProfile {
  uid: string; // Firebase document ID (auto-generated UUID)
  nickname: string;
  library: string;
  recoveryCode: string; // Separate field for recovery
  isProfileComplete: boolean;
  createdAt: Date;
  updatedAt: Date;
}
```

### 8. **Firebase Configuration**

#### Firestore Index
Required index for recovery code queries:
```json
{
  "indexes": [
    {
      "collectionGroup": "users",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "recoveryCode",
          "order": "ASCENDING"
        }
      ]
    }
  ]
}
```

Deploy index using:
```bash
firebase deploy --only firestore:indexes
```

#### Firestore Rules
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read: if true;
      allow create: if true;
      allow update: if true;
      allow delete: if false;
    }
  }
}
```

### 9. **Logout Behavior**
When user logs out:
1. User profile cleared from memory
2. `localStorage.removeItem('oebook_uid')`
3. `localStorage.removeItem('oebook_profile')`
4. User redirected to signup page
5. Must re-enter recovery code to access account

### 10. **Data Synchronization**
- On app load, system fetches profile by UID from localStorage
- If Firebase reachable, loads fresh data from Firestore
- If Firebase unreachable, uses cached profile data
- Updates are pushed to both Firebase (by UID) and localStorage

### 11. **Best Practices for Users**

#### What to Tell Users
1. **Save Your Recovery Code**: Write it down or save in password manager
2. **Keep it Secure**: Treat it like a password - anyone with the code can access your account
3. **Don't Share**: Recovery code is private and shouldn't be shared
4. **One Code per Account**: Each account has a unique recovery code
5. **No Recovery Options**: If you lose the code, account cannot be recovered

## Future Enhancements

### Possible Improvements
1. Email backup of recovery code
2. QR code generation for easier mobile transfer
3. Option to regenerate recovery code
4. Multi-device management
5. Recovery code strength indicator
6. Rate limiting on recovery attempts
7. Account activity log
8. Two-factor authentication option

### Migration Notes
- Existing users without recovery codes will need to re-register
- Or implement migration script to generate codes for existing accounts
- Consider grace period for transition

## Testing Checklist

- [ ] New user can register and receive recovery code
- [ ] Recovery code is copied correctly
- [ ] User can continue to app after registration
- [ ] Logged-in user stays logged in on page refresh
- [ ] User can log out successfully
- [ ] Recovery page validates code format
- [ ] Invalid recovery codes show appropriate errors
- [ ] Valid recovery code restores account
- [ ] Data syncs between Firebase and localStorage
- [ ] Works across different browsers on same device
- [ ] Works when Firebase is temporarily unavailable
- [ ] Multiple accounts can be created (different codes)
- [ ] Recovery code is truly unique (no collisions)
